version: 0.2

env:
  variables:
    APACHE_RUN_USER: "www-data"
    APACHE_RUN_GROUP: "www-data"
    APACHE_LOG_DIR: "/var/log/apache2"
phases:
  install:
    commands:
      - echo "$(lsb_release -cs)"
      - apt-get update -y
      - apt-get install -y git curl apache2 php5 libapache2-mod-php5 php5-mcrypt php5-mysql
      - curl -sS https://getcomposer.org/installer | php
      - mv composer.phar /usr/bin/composer
      - rm -rf /var/www/*
      - cp -pr . /var/www
      - cd /var/www && /usr/bin/composer install
      - a2enmod rewrite
      - chown -R www-data:www-data /var/www
      - cp apache.conf /etc/apache2/sites-available/default
      - CMD [EXPOSE 80]
      - CMD ["/usr/sbin/apache2", "-D",  "FOREGROUND"]
  pre_build:
    commands:
      - $(aws ecr get-login --no-include-email --region ca-central-1)
  build:
    commands:
      - sbt test
      - sbt docker:publish
  post_build:
    commands:
      - echo Build completed on `date`
artifacts:
  files:
    - Dockerrun.aws.json
